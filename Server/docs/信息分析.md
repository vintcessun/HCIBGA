# 信息分析：MaterialDetail → MaterialRecord 提示词

## 目标 / Deliverables / Success Criteria / 约束
- **目标**：编写一条 Cline 风格提示词，指导 LLM 将 `MaterialDetail` 类型数据转换为符合 Excel 表《信息学院推荐免试攻读硕士学位研究生成果加分登记表》要求的 `MaterialRecord` JSON。
- **可交付物**：`docs/信息分析.md`（当前文件），含字段映射解析与最终可复用提示词。
- **成功标准**：
  1. 提示词明确输入输出格式，且输出 JSON 需满足 `MaterialRecord` 结构。
  2. 明示各字段的提取/推断逻辑，并对 Excel 中的关键列进行引用。
  3. 采用 Cline 常用的分节/步骤表达方式，强调严格校验和自检。
- **约束条件**：
  - 语言使用简体中文；
  - 引用路径/文件：`api/llm.go` 中 `MaterialDetail` / `MaterialRecord` 定义；
  - 参考 Excel：`C:\Users\vintc\OneDrive - stu.xmu.edu.cn\学校\课程\大二上\交互设计\【公示】083112更新 信息学院推荐免试攻读硕士学位研究生成果加分登记表-样式.xlsx`；
  - 输出 JSON 严格遵守字段名与类型，数值字段使用数字而非字符串。

## 输入数据结构回顾
### MaterialDetail（api/llm.go）
- `ID`, `Title`, `Description`, `Category`, `Tags`, `Files`, `Status`, `Uploader`, `UploadTime`, `Reviewer`, `ReviewTime`, `ReviewComment`。
- AI 评估相关：`AiScore`, `AiConfidence`, `AiSuggestions`, `AiRiskLevel`。

### MaterialRecord（api/llm.go）
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `materialId` | string | 关联材料 ID，期望与 `MaterialDetail.ID` 一致 |
| `accountId` | string | 上传者账号，来源于 `MaterialDetail.Uploader` 或材料元数据 |
| `type` | string | 记录类别，对齐 Excel "系/大类" 或材料 `Category` |
| `category` | string | 记录 Excel 中 12%/8% 区块枚举，仅允许 `academic`（学术专长成绩）或 `comprehensive`（综合表现加分） |
| `id` | string | 学号字段，对应 Excel "学号" 列 |
| `project` | string | 项目/成果名称，对应 Excel 「项目（请填写全称）」列 |
| `awardDate` | string | 获奖/材料落款时间 |
| `awardType` | string | 奖项级别（Excel「奖项级别」列）或 tags 提炼结果 |
| `teamRank` | string | 集体/个人&队内排序，映射 Excel「个人或集体奖项」「集体奖项中第几作者」列 |
| `selfScore` | float64 | 自评加分（Excel「自评加分」列） |
| `scoreBasis` | string | 加分依据（Excel「加分依据」列） |
| `collegeScore` | float64 | 学院核定加分（Excel「学院核定加分」列） |

## Excel 关键信息摘要
- 表头包含基础信息（序号、系、所在专业、学号、姓名、性别、CET4/CET6、推免绩点、换算成绩）。
- “考核综合成绩（20%）”拆分为两块：
  1. **学术专长成绩（12%）**：项目 / 获奖时间 / 奖项级别 / 个人或集体 / 集体内排序 / 自评加分 / 加分依据 / 学院核定加分 / 学院核定总分。
  2. **综合表现加分（8%）**：字段同上。
- 表尾字段：考核综合成绩总分、综合成绩、专业成绩排名、排名人数。
- 关键列（用于提示词映射）：
  - 项目（Project）
  - 获奖时间（AwardDate）
  - 奖项级别（AwardType）
  - 个人或集体奖项 + 集体奖项第几作者（TeamRank）
  - 自评加分（SelfScore）
  - 加分依据（ScoreBasis）
  - 学院核定加分（CollegeScore）

## 字段映射逻辑建议
| MaterialRecord 字段 | Excel 列 / 语义 | 数据来源与处理策略 |
| --- | --- | --- |
| `materialId` | 序号之外的内部主键 | 直接取 `MaterialDetail.ID`，若缺失则生成稳定 UUID（提示词中要求） |
| `accountId` | 上传账号 | `MaterialDetail.Uploader`；若描述中有学号/账号，以 uploader 为主，描述为辅 |
| `type` | 系/类目 | 优先取 `MaterialDetail.Category`；若 tags 含更细致信息，拼接形成如 "学术专长成绩-科研成果" |
| `id` | 学号 | 在 `MaterialDetail.Description`、`Title`、`Tags` 或文件 OCR 内容中提取 10-14 位数字；找不到则留空字符串 |
| `project` | 项目名称 | 取 `Title`，若 title 缺乏标签信息，可附加主要 tag；必要时从 `Description` 中抽取赛事/项目名 |
| `awardDate` | 获奖时间 | 在 `Description` 中搜索 YYYY/MM/DD / YYYY年MM月 等日期；无则留空，并在 ScoreBasis 说明 |
| `awardType` | 奖项级别 | 根据 `Tags` 或描述中出现的 "国家级/省级/校级" 提取，无法确定时输出 "未知" |
| `teamRank` | 集体/作者排序 | 如果 Tags/描述含 "个人"、"团队"、"第X作者" 等；默认 "个人"，若检测到团队则写如 "团队-第1作者" |
| `selfScore` | 自评加分 | 优先解析描述中的加分/分值（含单位“分/加××”）；否则使用 `MaterialDetail.AiScore`（保留两位小数） |
| `scoreBasis` | 加分依据 | 用 1-2 句总结材料亮点、佐证文件、与 Excel 加分条款的对应关系 |
| `collegeScore` | 学院核定加分 | 若描述或 AI 结果含“学院核定/最终得分”，直接使用；否则基于 `AiScore * 0.8` 或自评加分（提示词说明取整规则） |

## Cline 风格提示词
````markdown
## 角色
你是校级推免材料分析官，需要把 `MaterialDetail` 输入整理成结构化 `MaterialRecord` JSON，用于填写《信息学院推荐免试攻读硕士学位研究生成果加分登记表》。

## 已知输入
- `MaterialDetail` JSON：含 `ID`, `Title`, `Description`, `Category`, `Tags`, `Files`, `Uploader`, `AiScore`, `AiConfidence`, `AiSuggestions`, `AiRiskLevel` 等字段。
- Excel 目标列：项目 / 获奖时间 / 奖项级别 / 个人或集体奖项 / 集体第几作者 / 自评加分 / 加分依据 / 学院核定加分 / 学院核定总分（参考“学术专长成绩（12%）”“综合表现加分（8%）”两块）。

## 输出要求
- 仅返回一个 JSON，字段与类型严格等于：
```json
{
  "materialId": "string",
  "accountId": "string",
  "type": "string",
  "category": "academic|comprehensive",
  "id": "string",
  "project": "string",
  "awardDate": "string",
  "awardType": "string",
  "teamRank": "string",
  "selfScore": 0,
  "scoreBasis": "string",
  "collegeScore": 0
}
```
- `category` 必须是 `"academic"` 或 `"comprehensive"`，表示材料对应 Excel 中的 "学术专长成绩（12%）" 或 "综合表现加分（8%）" 区块。
- 不得包含注释或额外文本；数值字段必须是数字类型。

## 步骤
1. **同步字段**：
   - `materialId = MaterialDetail.ID`；若为空，生成稳定 UUID（可将 `Title`+`Uploader` 哈希）。
   - `accountId = MaterialDetail.Uploader`。
   - `type = MaterialDetail.Category`，若 Tags 显示子类则拼接（例：`学术专长成绩-科研成果/期刊论文发表（A 类）`.
   - `category`：根据材料内容判断所属区块：
     - 若材料与学术成果、科研竞赛、学术荣誉等相关，写 `"academic"`；
     - 若材料属于综合表现、志愿服务、社会工作等，则写 `"comprehensive"`；
     - 若难以判断，可依据材料 `Category` / Tags / Excel 区块关键字映射，但不得输出其他值。
2. **提取学号与项目**：
   - 在标题/描述中使用正则匹配 10~14 位数字，优先填入 `id`；找不到则填空字符串，并在 `scoreBasis` 中说明“未提供学号”。
   - `project` 以 Title 为主，必要时附带核心 tag 或描述中的赛事/项目全称。
3. **获奖与级别信息**：
   - `awardDate`：解析描述中的日期（YYYY-MM-DD / YYYY年MM月 / 2024/07 等），格式化为 `YYYY-MM-DD`；无法确定则留空。
   - `awardType`：根据 Tags/描述中的“国家级/省级/校级/国际级”或 Excel 术语生成；无法识别时写 "未知"。
   - `teamRank`：判断“个人/集体”“第X作者/参赛者”，输出如 `"个人"`、`"团队-第1作者"`、`"团队-未说明"`。
4. **得分字段**（需结合 `category` 校验 Excel 区块的一致性）：
   - `selfScore`：
     - 若描述含“自评 X 分/加 X 分”，解析数值 (支持小数)；
     - 否则以 `MaterialDetail.AiScore` 作为自评分（保留两位小数）；
     - 缺失则填 `0`。
   - `scoreBasis`：组合描述、文件名、AI 建议，解释该材料对应 Excel 哪个加分条目（例如“依据《学术专长成绩-科研成果》第33次CCF CSP 软件能力认证，得分 4 分”）。
   - `collegeScore`：
     - 若描述或 AI 建议明确给出“学院核定加分/最终加分”，直接使用；
     - 否则采用 `min(selfScore, MaterialDetail.AiScore)`，若 AI 分缺失则与 `selfScore` 相同；
     - 保留两位小数。
5. **一致性校验**：
   - 确认 `scoreBasis` 中交代了判分条款或佐证文件；
   - `selfScore` 与 `collegeScore` >= 0；
   - 若 `awardDate`、`id`、`teamRank` 等缺失，需在 `scoreBasis` 说明缺失原因。
6. **最终自检**：
   - JSON 字段齐全且无 `null`；
   - 与 Excel 字段语义一致；
   - 输出前再检查是否存在英文逗号/引号错误，保证可被 `json.Unmarshal` 直接解析。
````
